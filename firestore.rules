/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all data is private to the user who created it.
 * Access is granted based on the user's authenticated UID matching the `userId` in the document path.
 *
 * Data Structure: The data is organized hierarchically under a `/users/{userId}` path. Each user has their own "data tree" containing
 * their profile, daily logs, projects, and documents in separate subcollections. This structure naturally isolates user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    match /users/{userId} {
      // Users can only read and write to their own profile.
      allow read, write: if isOwner(userId);

      // Rules for all subcollections under a user's document.
      // This single rule applies to dailyLogs, projects, documents, etc.
      // It ensures that only the owner of the parent user document can access
      // documents within these subcollections.
      match /{subcollection}/{docId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
